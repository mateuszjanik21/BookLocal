<div class="modal modal-open">
  <div class="modal-box w-11/12 max-w-2xl">

    @if (employee) {
    <button class="btn btn-sm btn-circle btn-ghost absolute right-2 top-2" (click)="closed.emit()">✕</button>

    <h3 class="font-bold text-xl pb-4 border-b border-base-300">
      Zarządzaj usługami dla: {{ employee.firstName }} {{ employee.lastName }}
    </h3>

    @if (isFormReady) {
    <form [formGroup]="servicesForm" (ngSubmit)="onSubmit()" class="mt-6">

      <div class="mb-4">
        <p class="font-semibold mb-2">Filtruj po kategorii:</p>
        <div class="flex flex-wrap gap-2">
          <button type="button" class="btn btn-sm" [class.btn-primary]="activeCategoryId === null"
            (click)="selectCategory(null)">
            Wszystkie
          </button>
          @for(category of categories; track category.serviceCategoryId) {
          <button type="button" class="btn btn-sm" [class.btn-primary]="activeCategoryId === category.serviceCategoryId"
            (click)="selectCategory(category.serviceCategoryId)">
            {{ category.name }}
          </button>
          }
        </div>
      </div>
      <div class="divider"></div>

      <div class="space-y-4 max-h-80 overflow-y-auto pr-2 mt-4" formArrayName="services">
        @for (category of categories; track category.serviceCategoryId) {
        @if(!activeCategoryId || activeCategoryId === category.serviceCategoryId) {
        <div>
          <h4 class="font-bold text-lg text-primary mb-2 sticky top-0 bg-base-100/80 backdrop-blur py-1 z-10">{{
            category.name }}</h4>

          @for(service of category.services; track service.id) {
          <div class="relative p-3 hover:bg-base-200 rounded-lg transition-colors duration-200">
            <label class="label cursor-pointer justify-start gap-4 p-0">
              <input type="checkbox" class="checkbox checkbox-primary"
                [formControlName]="getFormControlIndex(service.id)" />
              <span class="label-text text-base">{{ service.name }}</span>
            </label>
          </div>
          }
        </div>
        }
        }
      </div>

      <div class="modal-action mt-8 border-t border-base-200 pt-6">
        <button type="button" class="btn btn-ghost" (click)="closed.emit()">Anuluj</button>
        <button type="submit" class="btn btn-primary" [disabled]="!servicesForm.valid || !servicesForm.dirty">
          Zapisz zmiany
        </button>
      </div>
    </form>
    } @else {
    <div class="flex justify-center items-center p-16">
      <span class="loading loading-spinner loading-lg text-primary"></span>
    </div>
    }
    }
  </div>

  <form method="dialog" class="modal-backdrop">
    <button (click)="closed.emit()">close</button>
  </form>
</div>