<div class="modal modal-open" (click)="onBackdropClick($event)">
  <div class="modal-box w-11/12 max-w-2xl p-0 overflow-hidden">
    <div class="p-6 bg-base-200 flex items-center gap-4">
      <div class="bg-primary rounded-full p-2 text-primary-content">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9.568 3H5.25A2.25 2.25 0 0 0 3 5.25v4.318c0 .597.237 1.17.659 1.591l9.581 9.581c.699.699 1.78.872 2.607.33a18.095 18.095 0 0 0 5.223-5.223c.542-.827.369-1.908-.33-2.607L11.16 3.66A2.25 2.25 0 0 0 9.568 3Z" />
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 6h.008v.008H6V6Z" />
        </svg>
      </div>
      <div>
        <h3 class="font-bold text-lg">Przypisz Us≈Çugi</h3>
        @if (employee) {
          <p class="text-sm text-base-content/60">{{ employee.firstName }} {{ employee.lastName }}</p>
        }
      </div>
      <button type="button" class="btn btn-sm btn-circle btn-ghost ml-auto" (click)="cancel()">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>
    </div>

    @if (employee) {
      @if (isFormReady) {
        <form [formGroup]="servicesForm" (ngSubmit)="onSubmit()" class="p-6">
          <div class="flex flex-wrap gap-2 mb-4">
            <button type="button" class="btn btn-xs" [class.btn-primary]="activeCategoryId === null" (click)="selectCategory(null)">
              Wszystkie
            </button>
            @for (category of categories; track category.serviceCategoryId) {
              <button type="button" class="btn btn-xs" [class.btn-primary]="activeCategoryId === category.serviceCategoryId" (click)="selectCategory(category.serviceCategoryId)">
                {{ category.name }}
              </button>
            }
          </div>

          <div class="space-y-3 max-h-80 overflow-y-auto pr-2" formArrayName="services">
            @for (category of categories; track category.serviceCategoryId) {
              @if (!activeCategoryId || activeCategoryId === category.serviceCategoryId) {
                <div>
                  <h4 class="font-semibold text-sm text-primary mb-2 sticky top-0 bg-base-100 py-1 z-10">{{ category.name }}</h4>
                  @for (service of category.services; track service.id) {
                    <div class="p-2 hover:bg-base-200/50 rounded-lg transition-colors">
                      <label class="label cursor-pointer justify-start gap-3 p-0">
                        <input type="checkbox" class="checkbox checkbox-sm checkbox-primary" [formControlName]="getFormControlIndex(service.id)" />
                        <span class="label-text">{{ service.name }}</span>
                      </label>
                    </div>
                  }
                </div>
              }
            }
          </div>

          <div class="divider my-3"></div>

          <div class="flex justify-end gap-3">
            <button type="button" class="btn btn-ghost" (click)="cancel()">Anuluj</button>
            <button type="submit" class="btn btn-primary" [disabled]="!servicesForm.valid || !servicesForm.dirty">
              Zapisz zmiany
            </button>
          </div>
        </form>
      } @else {
        <div class="flex justify-center items-center p-16">
          <span class="loading loading-spinner loading-lg text-primary"></span>
        </div>
      }
    }
  </div>
</div>