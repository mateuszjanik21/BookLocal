<div class="container p-4 md:p-8 mx-auto">
  <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-6">
    <h1 class="text-3xl font-bold">Moje Rezerwacje</h1>
    <a routerLink="/" class="btn btn-primary mt-4 sm:mt-0">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" /></svg>
      Nowa rezerwacja
    </a>
  </div>

  <div class="tabs tabs-boxed mb-6">
    <a class="tab tab-lg flex-1" [class.tab-active]="activeTab === 'upcoming'" (click)="activeTab = 'upcoming'">Nadchodzące wizyty</a> 
    <a class="tab tab-lg flex-1" [class.tab-active]="activeTab === 'past'" (click)="activeTab = 'past'">Historia wizyt</a>
  </div>

  <div [hidden]="activeTab !== 'upcoming'">
    @if (isLoadingUpcoming) {
      <div class="flex justify-center items-center p-16">
        <span class="loading loading-spinner loading-lg text-primary"></span>
      </div>
    } @else {
      @if (upcomingReservations.length > 0) {
        <div class="space-y-4">
          @for (res of upcomingReservations; track res.reservationId) {
            <div class="card card-side bg-base-100 shadow-md flex-col sm:flex-row">
              <div class="p-4 sm:p-6 flex flex-col justify-center items-center sm:border-r border-base-200 text-center w-full sm:w-48">
                <p class="text-lg font-bold">{{ res.startTime | date:'d' }}</p>
                <p class="text-base-content/80">{{ res.startTime | date:'LLLL yyyy' }}</p>
                <p class="text-sm text-base-content/60">{{ res.startTime | date:'EEEE, HH:mm' }}</p>
              </div>
              <div class="card-body">
                <div class="flex justify-between items-start">
                  <div>
                    <h2 class="card-title text-primary">{{ res.serviceName }}</h2>
                    <p>{{ res.businessName }} ({{ res.employeeFullName }})</p>
                  </div>
                  <span class="badge" [ngClass]="{
                    'badge-success': res.status.toLowerCase() === 'confirmed',
                    'badge-error': res.status.toLowerCase() === 'cancelled'
                  }">{{ res.status | reservationStatus }}</span>
                </div>
                <div class="card-actions justify-end mt-4">
                  @if (res.status.toLowerCase() === 'confirmed') {
                    <button class="btn btn-error btn-sm btn-outline" (click)="onCancelReservation(res.reservationId)">Anuluj</button>
                  }
                </div>
              </div>
            </div>
          }
        </div>

        @if (hasMoreUpcoming) {
          <div class="text-center mt-8">
            <button class="btn btn-primary btn-wide" (click)="loadMoreUpcoming()" [disabled]="isLoadingMoreUpcoming">
              @if(isLoadingMoreUpcoming) { <span class="loading loading-spinner"></span> }
              Pokaż więcej
            </button>
          </div>
        }
      } @else {
        <div class="text-center p-8 bg-base-200 rounded-lg">
          <p>Nie masz żadnych nadchodzących rezerwacji.</p>
        </div>
      }
    }
  </div>

  <div [hidden]="activeTab !== 'past'">
    @if (isLoadingPast) {
      <div class="flex justify-center items-center p-16">
        <span class="loading loading-spinner loading-lg text-primary"></span>
      </div>
    } @else {
      @if (pastReservations.length > 0) {
        <div class="space-y-4">
          @for (res of pastReservations; track res.reservationId) {
            <div class="card card-side bg-base-100 shadow-md flex-col sm:flex-row opacity-80">
              <div class="p-4 sm:p-6 flex flex-col justify-center items-center sm:border-r border-base-200 text-center w-full sm:w-48">
                <p class="text-lg font-bold">{{ res.startTime | date:'d' }}</p>
                <p class="text-base-content/80">{{ res.startTime | date:'LLLL yyyy' }}</p>
                <p class="text-sm text-base-content/60">{{ res.startTime | date:'EEEE, HH:mm' }}</p>
              </div>
              <div class="card-body">
                <div class="flex justify-between items-start">
                  <div>
                    <h2 class="card-title">{{ res.serviceName }}</h2>
                    <p>{{ res.businessName }} ({{ res.employeeFullName }})</p>
                  </div>
                  <span class="badge" [ngClass]="{
                    'badge-error': res.status.toLowerCase() === 'cancelled',
                    'badge-neutral opacity-60': res.status.toLowerCase() === 'completed'
                  }">{{ res.status | reservationStatus }}</span>
                </div>
                <div class="card-actions justify-end mt-4">
                  @if (res.status.toLowerCase() === 'completed' && !res.hasReview) {
                    <button class="btn btn-primary btn-sm" (click)="openReviewModal(res)">Oceń wizytę</button>
                  }
                </div>
              </div>
            </div>
          }
        </div>

        @if (hasMorePast) {
          <div class="text-center mt-8">
            <button class="btn btn-primary btn-wide" (click)="loadMorePast()" [disabled]="isLoadingMorePast">
              @if(isLoadingMorePast) { <span class="loading loading-spinner"></span> }
              Pokaż więcej
            </button>
          </div>
        }
      } @else {
        <div class="text-center p-8 bg-base-200 rounded-lg">
          <p>Nie masz żadnych historycznych rezerwacji.</p>
        </div>
      }
    }
  </div>
</div>

@if(isReviewModalVisible) {
  <app-add-review-modal
    [reservation]="reservationToReview!"
    (closed)="closeReviewModal($event)">
  </app-add-review-modal>
}