<div class="card bg-base-100 shadow-xl border border-base-200 mb-8">
  <div class="card-body gap-4">

    <div class="flex flex-col gap-3 sm:flex-row sm:justify-between sm:items-center">
      <div class="flex items-center gap-2">
        <div>
          <h2 class="card-title text-2xl">Podsumowanie Finansowe</h2>
          <div class="flex items-center gap-2 mt-0.5">
            <p class="text-sm text-base-content/60">{{ selectedMonthLabel }} {{ selectedYear }}</p>
            @if (isRefreshing) {
              <span class="loading loading-spinner loading-xs text-primary"></span>
            }
          </div>
        </div>
      </div>
      <div class="flex flex-nowrap gap-1 sm:gap-2 items-center justify-between w-full sm:w-auto bg-base-200/50 sm:bg-transparent p-2 sm:p-0 rounded-xl sm:rounded-none">
        <button class="btn btn-ghost btn-sm btn-circle shrink-0" (click)="changeMonth(-1)" title="Poprzedni miesiƒÖc">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5L8.25 12l7.5-7.5" />
          </svg>
        </button>
        <select class="select select-sm select-bordered flex-1 sm:flex-none sm:w-32 min-w-0 font-medium"
          [(ngModel)]="selectedMonth" (ngModelChange)="loadAll()">
          @for (m of monthLabelsFull; track $index) {
            <option [value]="$index + 1">{{ m }}</option>
          }
        </select>
        <input type="number" class="input input-sm input-bordered w-16 sm:w-20 shrink-0 text-center font-medium"
          [(ngModel)]="selectedYear" (ngModelChange)="loadAll()"
          min="2020" max="2099" />
        <button class="btn btn-ghost btn-sm btn-circle shrink-0" (click)="changeMonth(1)" title="Nastƒôpny miesiƒÖc">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
          </svg>
        </button>
      </div>
    </div>

    @if (isLoading) {
      <div class="flex justify-center py-8"><span class="loading loading-spinner loading-md"></span></div>
    }

    @if (!isLoading) {
      <div [class.opacity-60]="isRefreshing" [class.pointer-events-none]="isRefreshing" class="transition-opacity duration-300">

      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">

        <div class="rounded-xl bg-success/10 border border-success/20 p-4">
          <p class="text-xs uppercase font-semibold text-success/70 tracking-wider mb-1">Przych√≥d</p>
          <p class="text-3xl font-bold text-success">{{ totalRevenue | number:'1.0-0' }}<span class="text-lg font-normal"> z≈Ç</span></p>
          <p class="text-xs text-base-content/50 mt-1">{{ reportsCount }} dni z raportami</p>
        </div>

        <div class="rounded-xl bg-error/10 border border-error/20 p-4">
          <p class="text-xs uppercase font-semibold text-error/70 tracking-wider mb-1">Koszty Zatrudnienia</p>
          <p class="text-3xl font-bold text-error">{{ totalEmployerCost | number:'1.0-0' }}<span class="text-lg font-normal"> z≈Ç</span></p>
          <p class="text-xs text-base-content/50 mt-1">{{ payrollsCount }} pracownik√≥w</p>
        </div>

        <div class="rounded-xl p-4 border"
          [ngClass]="netResult >= 0 ? 'bg-success/10 border-success/20' : 'bg-error/10 border-error/20'">
          <p class="text-xs uppercase font-semibold tracking-wider mb-1"
            [ngClass]="netResult >= 0 ? 'text-success/70' : 'text-error/70'">Wynik</p>
          <p class="text-3xl font-bold" [ngClass]="netResult >= 0 ? 'text-success' : 'text-error'">
            {{ netResult >= 0 ? '+' : '' }}{{ netResult | number:'1.0-0' }}<span class="text-lg font-normal"> z≈Ç</span>
          </p>
          <p class="text-xs text-base-content/50 mt-1">
            {{ netResult >= 0 ? 'Na plusie' : 'Na minusie' }}
          </p>
        </div>
      </div>

      @if (history.length > 0) {
        <div>
          <p class="text-xs font-semibold uppercase tracking-wider text-base-content/50 mb-3">Ostatnie 6 miesiƒôcy</p>
          <div class="flex gap-4 mb-2 text-xs text-base-content/60">
            <span class="flex items-center gap-1"><span class="inline-block w-3 h-3 rounded-sm bg-success/60"></span> Przych√≥d</span>
            <span class="flex items-center gap-1"><span class="inline-block w-3 h-3 rounded-sm bg-error/50"></span> Koszty</span>
          </div>
          <div class="flex gap-3 items-end h-28">
            @for (slot of history; track slot.month + '-' + slot.year) {
              <div class="flex-1 flex flex-col items-center gap-1 min-w-0">
                <div class="w-full flex gap-0.5 items-end h-20">
                  <div class="flex-1 rounded-t transition-all duration-500 min-h-0.5"
                    [ngClass]="slot.month === selectedMonth && slot.year === selectedYear ? 'bg-success' : 'bg-success/40'"
                    [style.height.%]="slot.revenueRatio * 100">
                  </div>
                  <div class="flex-1 rounded-t transition-all duration-500 min-h-0.5"
                    [ngClass]="slot.month === selectedMonth && slot.year === selectedYear ? 'bg-error' : 'bg-error/30'"
                    [style.height.%]="slot.costRatio * 100">
                  </div>
                </div>
                <p class="text-xs text-base-content/50 truncate w-full text-center leading-tight">{{ slot.shortLabel }}</p>
              </div>
            }
          </div>
        </div>
      }

      @if (noData) {
        <div class="text-center py-6 text-base-content/40">
          <p class="text-4xl mb-2">üìä</p>
          <p>Brak danych za wybrany miesiƒÖc.</p>
        </div>
      }
      </div>

    }

  </div>
</div>
