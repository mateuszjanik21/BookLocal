<div class="p-4 sm:p-6 lg:p-8 bg-base-200/30 min-h-screen">
  @if (isLoading) {
  <div>
    <div
      class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-8"
    >
      <div class="space-y-2">
        <div class="skeleton h-10 w-64"></div>
        <div class="skeleton h-4 w-96"></div>
      </div>
      <div class="skeleton h-12 w-full sm:w-48"></div>
    </div>
    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
      @for (_ of [0, 1, 2, 3]; track $index) {
      <div class="skeleton h-60 w-full rounded-xl"></div>
      }
    </div>
  </div>
  } @else { @if (business) {
  <div>
    <div
      class="flex flex-col sm:flex-row justify-between sm:items-start gap-4 mb-4"
    >
      <div>
        <h1 class="text-3xl font-bold text-base-content">Twoje Usługi</h1>
        <p class="mt-1 text-base-content/70">
          Zarządzaj ofertą usług i ich cennikami.
        </p>
      </div>
      <button
        class="btn btn-primary w-full sm:w-auto shadow-md hover:shadow-lg transition-shadow"
        (click)="openCategoryModal()"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 20 20"
          fill="currentColor"
          class="w-5 h-5"
        >
          <path
            d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"
          />
        </svg>
        Dodaj Nową Usługę
      </button>
    </div>

    <div class="form-control w-60 mb-8">
      <label class="cursor-pointer label">
        <span class="label-text">Pokaż archiwalne pozycje</span>
        <input
          type="checkbox"
          class="toggle toggle-primary"
          [(ngModel)]="showArchived"
          (ngModelChange)="loadData()"
          [disabled]="isRefreshing"
        />
      </label>
    </div>

    <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
      @for(category of business.categories; track category.serviceCategoryId) {
      <div
        class="card bg-base-100 shadow-lg border border-base-200/50 transition-all duration-300 hover:shadow-2xl hover:border-primary"
      >
        <div class="card-body p-5">
          <div class="flex items-center gap-4 border-b border-base-200 pb-4 mb-4">
            <div class="avatar">
              <div
                class="w-16 rounded-full ring-2 ring-primary ring-offset-base-100 ring-offset-2"
              >
                <img
                  [src]="category.photoUrl || 'assets/placeholder.svg'"
                  alt="Zdjęcie {{ category.name }}"
                />
              </div>
            </div>
            <div class="flex-grow">
               <h2 class="text-xl font-bold text-base-content">{{ category.name }}</h2>
               <div class="badge badge-sm badge-ghost mt-1">Usługa Główna</div>
            </div>
            
            <div class="dropdown dropdown-end">
              <label tabindex="0" class="btn btn-ghost btn-circle btn-sm">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  fill="none"
                  viewBox="0 0 24 24"
                  stroke-width="2"
                  stroke="currentColor"
                  class="w-5 h-5"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    d="M12 6.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 12.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 18.75a.75.75 0 110-1.5.75.75 0 010 1.5z"
                  />
                </svg>
              </label>
              <ul
                tabindex="0"
                class="dropdown-content menu p-2 shadow bg-base-200 rounded-box w-52 z-10 border border-base-300"
              >
                <li>
                  <button (click)="openCategoryModal(category)">
                    Edytuj usługę
                  </button>
                </li>
                <li>
                  <button
                    class="text-error"
                    (click)="onDeleteCategory(category)"
                  >
                    Usuń usługę
                  </button>
                </li>
              </ul>
            </div>
          </div>

          <!-- Cennik Header -->
          <div class="flex justify-between items-center mb-2">
             <h3 class="font-bold text-sm uppercase tracking-wider text-base-content/60">Cennik / Warianty</h3>
          </div>

          <div class="space-y-3">
            @for(service of category.services; track service.id) {
            <div
              class="collapse collapse-arrow border border-base-200 bg-base-100 rounded-box"
              [class.opacity-60]="service.isArchived"
            >
               <input type="checkbox" /> 
               <div class="collapse-title text-base font-medium flex items-center justify-between pr-10">
                  <div class="flex items-center gap-2">
                     <span>{{ service.name }}</span>
                     @if(service.isArchived) { <span class="badge badge-xs badge-ghost">Archiwum</span> }
                  </div>
                  <!-- Primary price preview -->
                  <div class="text-sm font-normal opacity-70">
                     @if(service.variants.length > 0) {
                        {{ service.variants[0].price }} PLN
                     }
                  </div>
               </div>
               
               <div class="collapse-content bg-base-200/30">
                  <div class="pt-2 space-y-2">
                     <div class="flex justify-end gap-2 mb-2">
                        @if(!service.isArchived) {
                          <button class="btn btn-xs btn-outline btn-primary" (click)="openVariantModal(service)">+ Dodaj opcję wariantu</button>
                          <div class="divider divider-horizontal mx-0"></div>
                          <button class="btn btn-xs btn-ghost" (click)="openEditServiceModal(service, category)">Edytuj opis usługi</button>
                          <button class="btn btn-xs btn-ghost text-error" (click)="onDeleteService(service)">Usuń usługę</button>
                        }
                     </div>
                     
                     <table class="table table-xs w-full">
                        <thead>
                           <tr>
                              <th>Wariant</th>
                              <th>Czas</th>
                              <th>Cena</th>
                              <th class="text-right">Akcje</th>
                           </tr>
                        </thead>
                        <tbody>
                           @for(variant of service.variants; track variant.serviceVariantId) {
                           <tr class="hover">
                              <td>{{ variant.name }}</td>
                              <td>{{ variant.durationMinutes }} min</td>
                              <td class="font-bold">{{ variant.price }} PLN</td>
                              <td class="text-right">
                                 <button class="btn btn-xs btn-square btn-ghost" (click)="openVariantModal(service, variant)">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
                                       <path d="M5.433 13.917l1.262-3.155A4 4 0 017.58 9.42l6.92-6.918a2.121 2.121 0 013 3l-6.92 6.918c-.383.383-.84.685-1.343.886l-3.154 1.262a.5.5 0 01-.65-.65z" />
                                       <path d="M3.5 5.75c0-.69.56-1.25 1.25-1.25H10A.75.75 0 0010 3H4.75A2.75 2.75 0 002 5.75v9.5A2.75 2.75 0 004.75 18h9.5A2.75 2.75 0 0017 15.25V10a.75.75 0 00-1.5 0v5.25c0 .69-.56 1.25-1.25 1.25h-9.5c-.69 0-1.25-.56-1.25-1.25v-9.5z" />
                                    </svg>
                                 </button>
                              </td>
                           </tr>
                           }
                        </tbody>
                     </table>
                  </div>
               </div>
            </div>
            } @empty {
            <div
              class="text-center py-8 px-4 border-2 border-dashed border-base-300 rounded-lg bg-base-200/20"
            >
              <p class="font-semibold text-base-content/60 text-sm">
                Cennik jest pusty
              </p>
              <button
                class="btn btn-primary btn-sm mt-3"
                (click)="openAddServiceModal(category)"
              >
                + Dodaj pozycję cennika
              </button>
            </div>
            }
          </div>

          @if (category.services.length > 0) {
          <div class="card-actions justify-end mt-4 pt-4 border-t border-base-200">
            <button
              class="btn btn-ghost btn-sm text-primary"
              (click)="openAddServiceModal(category)"
            >
              + Dodaj pozycję cennika
            </button>
          </div>
          }
        </div>
      </div>
      } @empty {
      <div
        class="col-span-full mt-12 flex flex-col items-center justify-center text-center bg-base-100 rounded-xl p-10 shadow-md border border-base-200/50"
      >
        <div class="p-5 bg-primary/10 rounded-full">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            fill="none"
            viewBox="0 0 24 24"
            stroke-width="1.5"
            stroke="currentColor"
            class="w-16 h-16 text-primary"
          >
             <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <h3 class="text-xl font-semibold mt-6">
          Zdefiniuj swoją pierwszą usługę
        </h3>
        <p class="text-base-content/70 mt-2 max-w-sm">
          Aby rozpocząć, dodaj główną usługę (np. "Strzyżenie"), a następnie zdefiniuj jej cennik.
        </p>
        <button class="btn btn-primary mt-6" (click)="openCategoryModal()">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 20 20"
            fill="currentColor"
            class="w-5 h-5"
          >
            <path
              d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z"
            />
          </svg>
          Dodaj Usługę
        </button>
      </div>
      }
    </div>
  </div>
  } }
</div>

@if (business) {
<app-category-modal
  [isVisible]="isCategoryModalVisible"
  [category]="categoryToEdit"
  [businessId]="business.id"
  [isLoading]="isSavingCategory"
  (closed)="closeCategoryModal()"
  (save)="onSaveCategory($event)"
>
</app-category-modal>

<app-add-service-modal
  [isVisible]="isAddServiceModalVisible"
  [businessId]="business.id"
  [categoryId]="activeCategoryForService?.serviceCategoryId ?? null"
  (closed)="closeServiceModalAndRefresh($event)"
>
</app-add-service-modal>

<app-edit-service-modal
  [isVisible]="!!serviceToEdit"
  [businessId]="business.id"
  [service]="serviceToEdit"
  (closed)="closeServiceModalAndRefresh($event)"
>
</app-edit-service-modal>

<app-variant-modal
  [isVisible]="isVariantModalVisible"
  [service]="activeServiceForVariant"
  [variant]="variantToEdit"
  [businessId]="business.id"
  (closed)="closeVariantModalAndRefresh($event)"
>
</app-variant-modal>
}
