<div class="p-3 sm:p-6 lg:p-8 bg-base-200/30 min-h-screen">
  @if (isLoading) {
  <div>
    <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 mb-8">
      <div class="space-y-2">
        <div class="skeleton h-10 w-48 sm:w-64"></div>
        <div class="skeleton h-4 w-full sm:w-96"></div>
      </div>
      <div class="skeleton h-12 w-full sm:w-48"></div>
    </div>
    <div class="grid grid-cols-1 xl:grid-cols-2 gap-4 sm:gap-6">
      @for (_ of [0, 1, 2, 3]; track $index) {
      <div class="skeleton h-60 w-full rounded-xl"></div>
      }
    </div>
  </div>
  } @else {
  @if (business) {
  <div>
    <div class="flex flex-col sm:flex-row justify-between sm:items-start gap-4 mb-6">
      <div>
        <h1 class="text-2xl sm:text-3xl font-bold text-base-content">Twoje Usługi</h1>
        <p class="mt-1 text-sm sm:text-base text-base-content/70">
          Zarządzaj ofertą usług i ich cennikami.
        </p>
      </div>
      <button class="btn btn-primary w-full sm:w-auto shadow-md hover:shadow-lg transition-shadow"
        (click)="openCategoryModal()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5">
          <path
            d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
        </svg>
        Dodaj Nową Usługę
      </button>
    </div>

    <div class="form-control w-full sm:w-60 mb-6 sm:mb-8">
      <label class="cursor-pointer label justify-start gap-3 sm:justify-between">
        <span class="label-text">Pokaż archiwalne pozycje</span>
        <input type="checkbox" class="toggle toggle-primary toggle-sm sm:toggle-md" [(ngModel)]="showArchived"
          (ngModelChange)="loadData()" [disabled]="isRefreshing" />
      </label>
    </div>

    <div class="grid grid-cols-1 xl:grid-cols-2 gap-4 sm:gap-6">
      @for (category of business.categories; track category.serviceCategoryId) {
      <div class="card bg-base-100 shadow-md sm:shadow-lg border border-base-200/50 transition-all duration-300">
        <div class="card-body p-3 sm:p-5">

          <div class="flex items-center gap-3 sm:gap-4 border-b border-base-200 pb-3 mb-3">
            <div class="avatar">
              <div class="w-12 sm:w-16 rounded-full ring-2 ring-primary ring-offset-base-100 ring-offset-2">
                <img [src]="category.photoUrl || 'assets/placeholder.svg'" alt="Zdjęcie {{ category.name }}" />
              </div>
            </div>
            <div class="flex-grow min-w-0">
              <h2 class="text-lg sm:text-xl font-bold text-base-content truncate">
                {{ category.name }}
              </h2>
              <div class="badge badge-xs sm:badge-sm badge-ghost mt-1">
                Usługa Główna
              </div>
            </div>

            <div class="dropdown dropdown-end">
              <label tabindex="0" class="btn btn-ghost btn-circle btn-sm">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                  stroke="currentColor" class="w-6 h-6 sm:w-5 sm:h-5">
                  <path stroke-linecap="round" stroke-linejoin="round"
                    d="M12 6.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 12.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 18.75a.75.75 0 110-1.5.75.75 0 010 1.5z" />
                </svg>
              </label>
              <ul tabindex="0"
                class="dropdown-content menu p-2 shadow-lg bg-base-200 rounded-box w-52 z-20 border border-base-300">
                @if (!category.isArchived) {
                <li><button (click)="openCategoryModal(category)">Edytuj usługę</button></li>
                <li><button class="text-error" (click)="openDeleteModal('category', category)">Usuń usługę</button></li>
                } @else {
                <li><button class="text-success" (click)="restoreCategory(category)">Przywróć usługę</button></li>
                }
              </ul>
            </div>
          </div>

          <div class="flex justify-between items-center mb-2 px-1">
            <h3 class="font-bold text-xs uppercase tracking-wider text-base-content/60">
              Cennik / Warianty
            </h3>
          </div>

          <div class="space-y-3">
            @for (service of category.services; track service.id) {
            <div class="collapse collapse-arrow border border-base-200 bg-base-100 rounded-box group"
              [class.opacity-60]="service.isArchived">
              <input type="checkbox" class="peer" />

              <div
                class="collapse-title text-sm sm:text-base font-medium flex items-center justify-between gap-2 pr-8 sm:pr-10 py-3 sm:py-4 min-h-[3rem]">
                <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2 leading-tight">
                  <span>{{ service.name }}</span>
                  @if (service.isArchived) {
                  <span class="badge badge-xs badge-ghost self-start sm:self-auto">Archiwum</span>
                  }
                </div>
                <div class="text-sm font-normal opacity-70 whitespace-nowrap">
                  @if (getDisplayPrice(service); as price) {
                  <span class="font-bold">{{ price }}</span> <span class="text-xs">PLN</span>
                  }
                </div>
              </div>

              <div class="collapse-content bg-base-200/30 px-3 sm:px-4">
                <div class="pt-4 space-y-4">

                  @if (service.description) {
                  <div
                    class="alert alert-ghost bg-base-100/50 text-xs sm:text-sm py-2 px-3 border border-base-200 shadow-sm flex items-start gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                      class="stroke-info shrink-0 w-4 h-4 mt-0.5">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    <span>{{ service.description }}</span>
                  </div>
                  }

                  <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-3">
                    <h4 class="font-bold text-xs uppercase tracking-wider text-base-content/50 hidden sm:block">
                      Warianty
                    </h4>
                    <div class="flex flex-wrap gap-2 w-full sm:w-auto">
                      @if (!service.isArchived && !category.isArchived) {
                      <button class="btn btn-xs btn-outline btn-primary flex-grow sm:flex-grow-0"
                        (click)="openVariantModal(service)">
                        + Wariant
                      </button>
                      <div class="divider divider-horizontal mx-0 hidden sm:flex"></div>
                      <button class="btn btn-xs btn-ghost flex-grow sm:flex-grow-0"
                        (click)="openEditServiceModal(service, category)">
                        Edytuj opis
                      </button>
                      <button class="btn btn-xs btn-ghost text-error flex-grow sm:flex-grow-0"
                        (click)="openDeleteModal('service', service)">
                        Usuń
                      </button>
                      } @else {
                      <span class="text-xs text-warning w-full sm:w-auto text-center sm:text-left">Zarchiwizowana</span>
                      <button class="btn btn-xs btn-outline btn-success w-full sm:w-auto"
                        (click)="restoreService(service)">
                        Przywróć
                      </button>
                      }
                    </div>
                  </div>

                  <div class="mt-2">
                    @if (service.variants.length > 0) {

                    <div class="flex flex-col gap-2.5">
                      @for (variant of service.variants; track variant.serviceVariantId) {
                      <div
                        class="flex flex-col sm:flex-row sm:items-center justify-between p-3 sm:p-4 bg-base-100 border border-base-200 rounded-lg hover:border-primary/30 transition-all duration-200 gap-3 sm:gap-0"
                        [class.opacity-60]="!variant.isActive">

                        <div
                          class="flex items-start justify-between sm:justify-start sm:items-center gap-2 w-full sm:w-auto overflow-hidden">
                          <div class="flex flex-col sm:flex-row sm:items-center gap-1 sm:gap-2 min-w-0">
                            <span class="font-medium text-base-content truncate text-[15px] sm:text-base">{{
                              variant.name }}</span>
                            @if (variant.isDefault) {
                            <span
                              class="badge badge-xs badge-ghost border-base-300 text-[10px] px-1.5 h-4 shrink-0 sm:ml-1">Domyślny</span>
                            }
                          </div>

                          <div class="sm:hidden font-bold text-lg text-primary tabular-nums leading-none">
                            {{ variant.price | number: "1.2-2" }} <span
                              class="text-xs font-normal text-base-content/60">zł</span>
                          </div>
                        </div>

                        <div class="flex items-center justify-between sm:justify-end gap-3 sm:gap-6 w-full sm:w-auto">
                          <div
                            class="hidden sm:block font-bold text-lg text-primary tabular-nums tracking-tight whitespace-nowrap">
                            {{ variant.price | number: "1.2-2" }} <span
                              class="text-xs font-normal text-base-content/60 ml-0.5">zł</span>
                          </div>

                          <button class="btn btn-sm btn-outline btn-ghost font-normal w-full sm:w-auto"
                            (click)="openVariantDetails(variant, service)">
                            Szczegóły
                          </button>
                        </div>

                      </div>
                      }
                    </div>

                    } @else {
                    <div
                      class="text-center py-5 px-4 bg-base-200/30 rounded-lg border border-dashed border-base-300 mx-1">
                      <p class="text-xs text-base-content/60 mb-3">Brak zdefiniowanych wariantów.</p>
                      @if (!service.isArchived && !category.isArchived) {
                      <button class="btn btn-xs btn-outline btn-primary" (click)="openVariantModal(service)">
                        Stwórz pierwszy wariant
                      </button>
                      } @else if(service.isArchived) {
                      <button class="btn btn-xs btn-success" (click)="restoreService(service)">
                        Przywróć usługę
                      </button>
                      }
                    </div>
                    }
                  </div>

                </div>
              </div>
            </div>
            } @empty {
            @if(!category.isArchived){
            <div class="text-center py-8 px-4 border-2 border-dashed border-base-300 rounded-lg bg-base-200/20">
              <p class="font-semibold text-base-content/60 text-sm">Cennik jest pusty</p>
              <button class="btn btn-primary btn-sm mt-3 w-full sm:w-auto" (click)="openAddServiceModal(category)">
                + Dodaj pozycję cennika
              </button>
            </div>
            }
            }
          </div>

          @if (category.services.length > 0) {
          <div class="mt-4 pt-3 border-t border-base-200">
            <button class="btn btn-ghost btn-sm text-primary w-full sm:w-auto sm:float-right"
              (click)="openAddServiceModal(category)">
              + Dodaj pozycję cennika
            </button>
          </div>
          }
        </div>
      </div>
      } @empty {
      <div
        class="col-span-full mt-8 sm:mt-12 flex flex-col items-center justify-center text-center bg-base-100 rounded-xl p-6 sm:p-10 shadow-md border border-base-200/50">
        <div class="p-4 sm:p-5 bg-primary/10 rounded-full">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
            stroke="currentColor" class="w-12 h-12 sm:w-16 sm:h-16 text-primary">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M12 6v12m-3-2.818l.879.659c1.171.879 3.07.879 4.242 0 1.172-.879 1.172-2.303 0-3.182C13.536 12.219 12.768 12 12 12c-.725 0-1.45-.22-2.003-.659-1.106-.879-1.106-2.303 0-3.182s2.9-.879 4.006 0l.415.33M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <h3 class="text-lg sm:text-xl font-semibold mt-4 sm:mt-6">Zdefiniuj swoją pierwszą usługę</h3>
        <p class="text-sm sm:text-base text-base-content/70 mt-2 max-w-sm">
          Aby rozpocząć, dodaj główną usługę (np. "Strzyżenie"), a następnie zdefiniuj jej cennik.
        </p>
        <button class="btn btn-primary mt-6 w-full sm:w-auto" (click)="openCategoryModal()">
          Dodaj Usługę
        </button>
      </div>
      }
    </div>
  </div>
  }
  }
</div>

@if (business) {
<app-category-modal [isVisible]="isCategoryModalVisible" [category]="categoryToEdit" [businessId]="business.id"
  [isLoading]="isSavingCategory" (closed)="closeCategoryModal()" (save)="onSaveCategory($event)">
</app-category-modal>

<app-add-service-modal [isVisible]="isAddServiceModalVisible" [businessId]="business.id"
  [categoryId]="activeCategoryForService?.serviceCategoryId ?? null" (closed)="closeServiceModalAndRefresh($event)">
</app-add-service-modal>

<app-edit-service-modal [isVisible]="!!serviceToEdit" [businessId]="business.id" [service]="serviceToEdit"
  (closed)="closeServiceModalAndRefresh($event)">
</app-edit-service-modal>

<app-variant-modal [isVisible]="isVariantModalVisible" [service]="activeServiceForVariant" [variant]="variantToEdit"
  [businessId]="business.id" (closed)="closeVariantModalAndRefresh($event)">
</app-variant-modal>

<dialog id="delete_modal" class="modal modal-bottom sm:modal-middle">
  <div class="modal-box">
    @if (deleteConfig) {
    @switch (deleteConfig.type) {
    @case ('category') {
    <h3 class="font-bold text-lg text-error">Usuń kategorię</h3>
    <p class="py-4">Usuwasz <span class="font-bold">{{ deleteConfig.item.name }}</span>. Wszystkie usługi zostaną
      zarchiwizowane.</p>
    }
    @case ('service') {
    <h3 class="font-bold text-lg text-error">Archiwizuj usługę</h3>
    <p class="py-4">Przenosisz <span class="font-bold">{{ deleteConfig.item.name }}</span> do archiwum.</p>
    }
    @case ('variant') {
    <h3 class="font-bold text-lg text-error">Usuń wariant</h3>
    <p class="py-4">Usuwasz wariant <span class="font-bold">{{ deleteConfig.item.name }}</span>.</p>
    }
    }
    }
    <div class="modal-action">
      <form method="dialog" class="flex w-full gap-2">
        <button class="btn btn-ghost flex-1" (click)="closeDeleteModal()" [disabled]="isDeleting">Anuluj</button>
        <button class="btn btn-error flex-1" (click)="confirmDelete()" [disabled]="isDeleting">
          @if(isDeleting) { <span class="loading loading-spinner"></span> } Usuń
        </button>
      </form>
    </div>
  </div>
  <form method="dialog" class="modal-backdrop">
    <button (click)="closeDeleteModal()" [disabled]="isDeleting">close</button>
  </form>
</dialog>

<dialog id="variant_details_modal" class="modal modal-bottom sm:modal-middle">
  <div class="modal-box">
    @if (selectedVariantForDetails) {
    <h3 class="font-bold text-lg pr-8">{{ selectedVariantForDetails.name }}</h3>

    <div class="py-4 space-y-4">

      <div class="flex flex-wrap gap-2">
        @if (selectedVariantForDetails.isDefault) {
        <div class="badge badge-neutral">Domyślny</div>
        }
        @if (selectedVariantForDetails.isActive) {
        <div class="badge badge-success badge-outline">Aktywny</div>
        } @else {
        <div class="badge badge-error badge-outline">Nieaktywny</div>
        }
      </div>

      <div class="grid grid-cols-2 gap-4 text-sm">
        <div class="flex flex-col gap-1">
          <span class="text-base-content/60 text-xs uppercase tracking-wider">Cena</span>
          <span class="font-bold text-xl text-primary">{{ selectedVariantForDetails.price | number:'1.2-2' }} zł</span>
        </div>

        <div class="flex flex-col gap-1">
          <span class="text-base-content/60 text-xs uppercase tracking-wider">Polubienia</span>
          <div class="flex items-center gap-1 font-medium text-secondary">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4">
              <path
                d="M9.653 16.915l-.005-.003-.019-.01a20.759 20.759 0 01-1.16-1.1c-1.07-1.07-5.84-6.22-6.52-8.514A4.9 4.9 0 016.96 1.763c1.94 0 3.3.93 4.14 2.155a4.9 4.9 0 015.68-.005 5.03 5.03 0 011.66 3.9c-.68 2.29-5.45 7.44-6.52 8.514a20.76 20.76 0 01-1.16 1.1l-.019.01-.005.003h-.001z" />
            </svg>
            <span>{{ selectedVariantForDetails.favoritesCount }}</span>
          </div>
        </div>

        <div class="flex flex-col gap-1">
          <span class="text-base-content/60 text-xs uppercase tracking-wider">Czas trwania</span>
          <div class="flex items-center gap-1 font-medium">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
              stroke="currentColor" class="w-4 h-4 opacity-70">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>{{ selectedVariantForDetails.durationMinutes }} min</span>
          </div>
        </div>

        <div class="flex flex-col gap-1">
          <span class="text-base-content/60 text-xs uppercase tracking-wider">Sprzątanie</span>
          <div class="flex items-center gap-1 font-medium text-warning">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
              stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round"
                d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z" />
            </svg>
            <span>+{{ selectedVariantForDetails.cleanupTimeMinutes }} min</span>
          </div>
        </div>
      </div>

    </div>

    <div class="modal-action">
      <form method="dialog" class="flex w-full gap-2">
        <button class="btn btn-ghost" (click)="closeVariantDetails()">Zamknij</button>
        <div class="flex-grow"></div>
        @if (selectedVariantForDetails.isActive) {
        <button class="btn btn-outline" (click)="openEditFromDetails()">Edytuj</button>
        <button class="btn btn-error" (click)="openDeleteFromDetails()">Usuń</button>
        } @else {
        <span class="text-xs text-warning self-center mr-2">Wariant zarchiwizowany</span>
        @if (selectedServiceForDetails && !selectedServiceForDetails.isArchived) {
        <button class="btn btn-outline btn-success" (click)="restoreFromDetails()">Przywróć</button>
        }
        }
      </form>
    </div>
    }
  </div>
  <form method="dialog" class="modal-backdrop">
    <button (click)="closeVariantDetails()">close</button>
  </form>
</dialog>
}