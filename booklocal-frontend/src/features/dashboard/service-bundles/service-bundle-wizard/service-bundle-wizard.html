<div class="p-4 sm:p-6 lg:p-8 bg-base-200/30 min-h-screen">
  <div class="max-w-4xl mx-auto">
    
    <!-- Header -->
    <div class="flex items-center gap-4 mb-8">
        <button class="btn btn-circle btn-ghost" routerLink="../">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
            </svg>
        </button>
        <div>
            <h1 class="text-2xl font-bold">Kreator Pakietu</h1>
            <p class="text-base-content/70">Krok {{ currentStep }} z 3: {{ getStepTitle() }}</p>
        </div>
    </div>

    <!-- Progress -->
    <ul class="steps w-full mb-8">
        <li class="step" [class.step-primary]="currentStep >= 1">Podstawowe Info</li>
        <li class="step" [class.step-primary]="currentStep >= 2">Wybór Usług</li>
        <li class="step" [class.step-primary]="currentStep >= 3">Podsumowanie</li>
    </ul>

    <!-- Step 1: Info -->
    @if(currentStep === 1) {
        <div class="card bg-base-100 shadow-xl border border-base-200">
            <div class="card-body">
                <div class="form-control">
                    <label class="label"><span class="label-text font-bold">Nazwa Pakietu</span></label>
                    <input type="text" [(ngModel)]="bundleName" placeholder="np. Relaksujący Dzień SPA" class="input input-bordered" />
                </div>
                <div class="form-control">
                    <label class="label"><span class="label-text">Opis</span></label>
                    <textarea [(ngModel)]="bundleDescription" class="textarea textarea-bordered h-24" placeholder="Krótki opis pakietu..."></textarea>
                </div>
                
                <div class="form-control">
                    <label class="label"><span class="label-text">Zdjęcie (opcjonalne)</span></label>
                    <input type="file" (change)="onFileSelected($event)" class="file-input file-input-bordered w-full max-w-xs" accept="image/*" />
                </div>

                <div class="form-control">
                    <label class="label"><span class="label-text font-bold">Cena Pakietu (PLN)</span></label>
                    <input type="number" [(ngModel)]="bundlePrice" class="input input-bordered" placeholder="0.00" />
                    <label class="label">
                        <span class="label-text-alt text-warning" *ngIf="items.length > 0">Suma cen usług składowych: {{ calculateTotalItemsPrice() }} PLN</span>
                    </label>
                </div>
                
                <div class="card-actions justify-end mt-4">
                    <button class="btn btn-primary" (click)="nextStep()" [disabled]="!bundleName || !bundlePrice">Dalej</button>
                </div>
            </div>
        </div>
    }

    <!-- Step 2: Items -->
    @if(currentStep === 2) {
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Left: Selector -->
            <div class="card bg-base-100 shadow-lg border border-base-200 h-fit">
                <div class="card-body">
                    <h3 class="font-bold text-lg mb-4">Dodaj usługę do pakietu</h3>
                    
                    <div class="form-control mb-4">
                        <label class="label">Kategoria</label>
                        <select class="select select-bordered" [(ngModel)]="selectedCategory" (change)="onCategoryChange()">
                            <option [ngValue]="null">Wybierz...</option>
                            @for(cat of categories; track cat.serviceCategoryId) {
                                <option [ngValue]="cat">{{ cat.name }}</option>
                            }
                        </select>
                    </div>

                    @if(selectedCategory) {
                        <div class="form-control mb-4">
                            <label class="label">Usługa</label>
                            <select class="select select-bordered" [(ngModel)]="selectedService" (change)="onServiceChange()">
                                <option [ngValue]="null">Wybierz...</option>
                                @for(srv of selectedCategory.services; track srv.id) {
                                    <option [ngValue]="srv">{{ srv.name }}</option>
                                }
                            </select>
                        </div>
                    }

                    @if(selectedService) {
                         <div class="space-y-2">
                            <label class="label font-bold">Wybierz wariant:</label>
                            @for(variant of selectedService.variants; track variant.serviceVariantId) {
                                <div class="flex items-center justify-between p-3 border rounded-lg hover:bg-base-200 cursor-pointer" (click)="addVariant(variant)">
                                    <div>
                                        <div class="font-bold">{{ variant.name }}</div>
                                        <div class="text-xs">{{ variant.durationMinutes }} min</div>
                                    </div>
                                    <div class="font-mono text-primary font-bold">{{ variant.price }} zł</div>
                                    <button class="btn btn-xs btn-circle btn-primary">+</button>
                                </div>
                            }
                         </div>
                    }
                </div>
            </div>

            <!-- Right: Current List -->
            <div class="card bg-base-100 shadow-lg border border-base-200">
                <div class="card-body">
                    <h3 class="font-bold text-lg mb-4">Wybrane usługi ({{ items.length }})</h3>
                    @if(items.length === 0) {
                        <p class="text-base-content/50 italic text-center py-8">Brak usług. Dodaj coś z lewej strony.</p>
                    } @else {
                        <div class="space-y-2">
                             @for(item of items; track $index) {
                                <div class="flex items-center gap-3 p-3 bg-base-200 rounded-lg group">
                                    <span class="badge badge-neutral shadow font-mono text-xs w-6 h-6 flex items-center justify-center">{{ $index + 1 }}</span>
                                    <div class="flex-grow">
                                        <div class="font-bold text-sm">{{ item.serviceName }}</div>
                                        <div class="text-xs opacity-70">{{ item.variantName }} • {{ item.durationMinutes }} min</div>
                                    </div>
                                    <div class="flex gap-1">
                                        <button class="btn btn-ghost btn-xs" (click)="moveItem(item, -1)" [disabled]="$first">⬆</button>
                                        <button class="btn btn-ghost btn-xs" (click)="moveItem(item, 1)" [disabled]="$last">⬇</button>
                                        <button class="btn btn-ghost btn-xs text-error" (click)="removeItem($index)">✕</button>
                                    </div>
                                </div>
                             }
                        </div>
                        <div class="mt-4 text-xs text-center text-base-content/60">
                            Użyj strzałek, aby ustalić kolejność wykonywania usług.
                        </div>
                    }

                     <div class="card-actions justify-between mt-8">
                        <button class="btn btn-ghost" (click)="currentStep = 1">Wróć</button>
                        <button class="btn btn-primary" (click)="nextStep()" [disabled]="items.length === 0">Dalej</button>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- Step 3: Summary -->
    @if(currentStep === 3) {
        <div class="card bg-base-100 shadow-xl border border-base-200 max-w-2xl mx-auto">
            <div class="card-body">
                <h2 class="card-title text-2xl">{{ bundleName }}</h2>
                <p>{{ bundleDescription }}</p>
                <div class="divider"></div>
                
                 <div class="overflow-x-auto">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Usługa</th>
                                <th>Czas</th>
                                <th>Wartość</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for(item of items; track $index) {
                                <tr>
                                    <th>{{ $index + 1 }}</th>
                                    <td>
                                        <div class="font-bold">{{ item.serviceName }}</div>
                                        <div class="text-xs opacity-50">{{ item.variantName }}</div>
                                    </td>
                                    <td>{{ item.durationMinutes }} min</td>
                                    <td>{{ item.originalPrice }} zł</td>
                                </tr>
                            }
                        </tbody>
                        <tfoot>
                            <tr>
                                <th colspan="3" class="text-right">Suma wartości:</th>
                                <th>{{ calculateTotalItemsPrice() }} zł</th>
                            </tr>
                            <tr>
                                <th colspan="3" class="text-right text-lg text-primary">Cena Pakietu:</th>
                                <th class="text-lg text-primary">{{ bundlePrice.toFixed(2) }} zł</th>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="alert shadow-sm mt-4">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-info shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    <div>
                        <h3 class="font-bold">Zaoszczędzasz {{ (calculateTotalItemsPrice() - bundlePrice).toFixed(2) }} zł</h3>
                        <div class="text-xs">Różnica między sumą cen usług a ceną pakietu.</div>
                    </div>
                </div>

                <div class="card-actions justify-between mt-8">
                    <button class="btn btn-ghost" (click)="currentStep = 2">Wróć</button>
                    <button class="btn btn-success text-white px-8" (click)="createBundle()" [disabled]="isSaving">
                        @if(isSaving) { <span class="loading loading-spinner"></span> }
                        Utwórz Pakiet
                    </button>
                </div>
            </div>
        </div>
    }

  </div>
</div>
