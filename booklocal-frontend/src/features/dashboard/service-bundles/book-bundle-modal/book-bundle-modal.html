<div class="modal modal-open">
  <div class="modal-box w-11/12 max-w-5xl h-[90vh]">
    <h3 class="font-bold text-lg mb-4">Umów Pakiet: {{ bundle?.name }}</h3>
    
    <div class="flex flex-col h-full gap-4">
      <!-- Steps -->
      <ul class="steps w-full">
        <li class="step" [class.step-primary]="currentStep >= 1">Wybierz Pracownika</li>
        <li class="step" [class.step-primary]="currentStep >= 2">Wybierz Termin</li>
        <li class="step" [class.step-primary]="currentStep >= 3">Potwierdzenie</li>
      </ul>

      <!-- Step 1: Employee Selection -->
      <div *ngIf="currentStep === 1" class="overflow-y-auto flex-1">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          @for (emp of employees; track emp.id) {
            <div 
              class="card bg-base-100 shadow-xl border border-base-200 cursor-pointer hover:border-primary transition-all"
              [class.border-primary]="selectedEmployee?.id === emp.id"
              (click)="selectEmployee(emp)">
              <div class="card-body items-center text-center p-4">
                <div class="avatar placeholder mb-2">
                  <div class="bg-neutral text-neutral-content rounded-full w-16">
                    <img *ngIf="emp.photoUrl" [src]="emp.photoUrl" />
                    <span *ngIf="!emp.photoUrl" class="text-xl">{{ emp.firstName[0] }}{{ emp.lastName[0] }}</span>
                  </div>
                </div>
                <h3 class="font-bold">{{ emp.firstName }} {{ emp.lastName }}</h3>
                <p class="text-sm text-base-content/70">{{ emp.position }}</p>
              </div>
            </div>
          }
        </div>
      </div>

      <!-- Step 2: Date & Time Selection -->
      <div *ngIf="currentStep === 2" class="flex flex-col md:flex-row gap-6 h-full overflow-hidden">
        <!-- Date Picker (Simplified) -->
        <div class="w-full md:w-1/3">
           <div class="form-control">
             <label class="label"><span class="label-text">Wybierz dzień</span></label>
             <input type="date" [ngModel]="selectedDate | date:'yyyy-MM-dd'" (ngModelChange)="onDateChange($event)" class="input input-bordered w-full" />
           </div>
        </div>

        <!-- Slots -->
        <div class="w-full md:w-2/3 overflow-y-auto">
            <h4 class="font-bold mb-2">Dostępne godziny (Cały pakiet: {{ (bundle?.totalPrice ?? 0) | currency:'PLN' }})</h4>
            
            @if (isLoadingSlots) {
                <div class="flex justify-center p-4"><span class="loading loading-spinner loading-lg"></span></div>
            } @else if (availableSlots.length === 0) {
                <div class="alert">Brak wolnych terminów w wybranym dniu.</div>
            } @else {
                <div class="grid grid-cols-3 md:grid-cols-4 gap-2">
                    @for (slot of availableSlots; track slot) {
                        <button 
                            class="btn btn-outline btn-sm" 
                            [class.btn-active]="selectedSlot === slot"
                            (click)="selectSlot(slot)">
                            {{ slot | date:'HH:mm' }}
                        </button>
                    }
                </div>
            }
        </div>
      </div>

       <!-- Step 3: Summary -->
       <div *ngIf="currentStep === 3" class="flex-1 flex flex-col items-center justify-center gap-4">
          <div class="stats shadow">
            <div class="stat">
                <div class="stat-title">Pakiet</div>
                <div class="stat-value text-primary text-2xl">{{ bundle?.name }}</div>
                <div class="stat-desc">{{ bundle?.items?.length }} usług</div>
            </div>
            <div class="stat">
                <div class="stat-title">Pracownik</div>
                <div class="stat-value text-secondary text-2xl">{{ selectedEmployee?.firstName }}</div>
            </div>
            <div class="stat">
                <div class="stat-title">Termin</div>
                <div class="stat-value text-2xl">{{ selectedSlot | date:'dd.MM HH:mm' }}</div>
            </div>
          </div>

          <!-- Guest Info -->
          <div *ngIf="isOwnerMode">
            <div class="form-control w-full max-w-xs">
                <label class="label"><span class="label-text">Imię i Nazwisko Klienta</span></label>
                <input type="text" [(ngModel)]="guestName" placeholder="np. Anna Nowak" class="input input-bordered w-full" />
            </div>
            <div class="form-control w-full max-w-xs">
                <label class="label"><span class="label-text">Telefon (opcjonalnie)</span></label>
                <input type="text" [(ngModel)]="guestPhone" placeholder="123 456 789" class="input input-bordered w-full" />
            </div>
          </div>

          <div class="card w-96 bg-base-100 shadow-xl border border-base-200">
             <div class="card-body p-4">
                <h4 class="font-bold mb-2">Harmonogram usług:</h4>
                <ul class="timeline timeline-vertical timeline-compact">
                    @for (item of bundle?.items; track item.serviceBundleItemId; let i = $index) {
                        <li>
                            <hr *ngIf="i > 0" />
                            <div class="timeline-middle">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79-1.88-1.88a.75.75 0 10-1.06 1.061l2.5 2.5a.75.75 0 001.137-.089l4-5.5z" clip-rule="evenodd" /></svg>
                            </div>
                            <div class="timeline-end timeline-box">{{ item.serviceName }} - {{ item.variantName }} <span class="text-xs opacity-50">({{ item.durationMinutes }} min)</span></div>
                            <hr *ngIf="i < (bundle?.items?.length ?? 0) - 1" />
                        </li>
                    }
                </ul>
             </div>
          </div>
       </div>

      <!-- Footer Actions -->
      <div class="modal-action mt-auto">
        <button class="btn" (click)="close.emit()">Anuluj</button>
        <button class="btn" *ngIf="currentStep > 1" (click)="currentStep = currentStep - 1">Wstecz</button>
        <button class="btn btn-primary" *ngIf="currentStep < 3" [disabled]="!canProceed()" (click)="nextStep()">Dalej</button>
        <button class="btn btn-success text-white" *ngIf="currentStep === 3" [disabled]="isSaving" (click)="confirmBooking()">
            <span *ngIf="isSaving" class="loading loading-spinner"></span>
            Potwierdź Rezerwację
        </button>
      </div>
    </div>
  </div>
</div>
