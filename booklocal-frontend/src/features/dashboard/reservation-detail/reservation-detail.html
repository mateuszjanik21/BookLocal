@if(isLoading) {
  <div class="flex justify-center items-center p-16">
    <span class="loading loading-spinner loading-lg text-primary"></span>
  </div>
} @else {
  @if(reservation) {
    <div class="p-4 sm:p-6 lg:p-8">
      <div class="mb-6">
        <a routerLink="/dashboard/reservations" class="btn btn-ghost">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M17 10a.75.75 0 01-.75.75H5.612l4.158 3.96a.75.75 0 11-1.04 1.08l-5.5-5.25a.75.75 0 010-1.08l5.5-5.25a.75.75 0 111.04 1.08L5.612 9.25H16.25A.75.75 0 0117 10z" clip-rule="evenodd" /></svg>
          Wszystkie rezerwacje
        </a>
      </div>

      @if(reservation.isServiceArchived) {
        <div role="alert" class="alert alert-warning mb-6 shadow-md">
          <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
          <span>Uwaga: Usługa powiązana z tą rezerwacją została zarchiwizowana. Nie można modyfikować statusu.</span>
        </div>
      }

      <div class="card lg:card-side bg-base-100 shadow-xl">
        <div class="card-body">
          <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-4 pb-4 border-b border-base-200">
            <div>
              <h2 class="card-title text-2xl">Rezerwacja #{{ reservation.reservationId }}</h2>
              <p class="text-base-content/60 mt-1">Status: 
                <span class="badge font-semibold" [ngClass]="{
                  'badge-primary': reservation.status.toLowerCase() === 'confirmed',
                  'badge-neutral': reservation.status.toLowerCase() === 'completed',
                  'badge-error': reservation.status.toLowerCase() === 'cancelled'
                }">{{ reservation.status | reservationStatus }}</span>
              </p>
            </div>
            <div class="flex gap-2">
              <button 
                class="btn btn-outline" 
                (click)="startChat(reservation.customerId)"
                [disabled]="!reservation.customerId"
                [class.btn-disabled]="!reservation.customerId"
                [title]="!reservation.customerId ? 'Klient nie ma konta w serwisie' : 'Napisz do klienta'">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5"><path fill-rule="evenodd" d="M10 2c-4.42 0-8 3.134-8 7 0 2.454 1.32 4.613 3.33 5.885v2.813a.5.5 0 00.854.354L8.4 15.556A8.003 8.003 0 0010 16c4.42 0 8-3.134 8-7s-3.58-7-8-7zm0 12a6.003 6.003 0 01-1.8-.29l-2.12.955a.5.5 0 01-.65-.65l.59-1.965A5.968 5.968 0 014 9c0-3.033 2.686-5.5 6-5.5s6 2.467 6 5.5-2.686 5.5-6 5.5z" clip-rule="evenodd" /></svg>
                Wiadomość
              </button>
              
              <div class="dropdown dropdown-end" [class.dropdown-disabled]="reservation.isServiceArchived">
                <label tabindex="0" class="btn btn-primary" [class.loading]="isUpdating">
                  Zmień status
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                </label>
                @if(!reservation.isServiceArchived){
                  <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-200 rounded-box w-52 z-10">
                    @for(status of statuses; track status) {
                      <li>
                        <a (click)="changeStatus(status)" [class.active]="reservation.status === status">
                          {{ status | reservationStatus }}
                        </a>
                      </li>
                    }
                  </ul>
                }
              </div>
              
              @if(reservation.status === 'Completed' && reservation.customerId) {
                <button 
                    class="btn btn-outline ml-2" 
                    (click)="generateInvoice()" 
                    [disabled]="isGeneratingInvoice">
                    @if(isGeneratingInvoice) { <span class="loading loading-spinner"></span> }
                    Wystaw Fakturę
                </button>
              }
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6">
            <div>
              <h3 class="font-semibold text-lg mb-2">Szczegóły Wizyty</h3>
              <p><strong>Usługa:</strong> {{ reservation.serviceName }}</p>
              <p><strong>Pracownik:</strong> {{ reservation.employeeFullName }}</p>
              <p><strong>Data:</strong> {{ reservation.startTime | date: 'fullDate' }}</p>
              <p><strong>Godzina:</strong> {{ reservation.startTime | date: 'HH:mm' }} - {{ reservation.endTime | date: 'HH:mm' }}</p>
            </div>
            <div>
              <h3 class="font-semibold text-lg mb-2">Informacje o Kliencie</h3>
              <p><strong>Imię i nazwisko:</strong> {{ reservation.customerFullName || reservation.guestName }}</p>
            </div>
          </div>
        </div>
      </div>
    <div class="card lg:card-side bg-base-100 shadow-xl mt-6">
       <div class="card-body">
         <div class="flex justify-between items-center mb-4">
             <h3 class="card-title text-xl">Płatności</h3>
             <div class="dropdown dropdown-end">
                 <label tabindex="0" class="btn btn-sm btn-outline btn-success" [class.loading]="isAddingPayment">
                     <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                         <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                     </svg>
                     Dodaj Płatność
                 </label>
                 <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52 border border-base-200">
                     <li><a (click)="addManualPayment('Cash')">Gotówka</a></li>
                     <li><a (click)="addManualPayment('Card')">Karta</a></li>
                     <li><a (click)="addManualPayment('Other')">Inne</a></li>
                 </ul>
             </div>
         </div>
 
         <div class="overflow-x-auto">
             <table class="table table-sm">
                 <thead>
                     <tr>
                         <th>Data</th>
                         <th>Metoda</th>
                         <th>Status</th>
                         <th>Kwota</th>
                     </tr>
                 </thead>
                 <tbody>
                     @for(payment of payments; track payment.paymentId) {
                         <tr>
                             <td>{{ payment.transactionDate | date:'short' }}</td>
                             <td>{{ payment.method }}</td>
                             <td>
                                 <span class="badge badge-sm badge-success" *ngIf="payment.status === 'Completed'">Opłacona</span>
                                 <span class="badge badge-sm" *ngIf="payment.status !== 'Completed'">{{ payment.status }}</span>
                             </td>
                             <td class="font-bold font-mono">{{ payment.amount | currency:'PLN':'symbol':'1.2-2' }}</td>
                         </tr>
                     } @empty {
                         <tr>
                             <td colspan="4" class="text-center text-base-content/60 py-4">Brak zarejestrowanych płatności.</td>
                         </tr>
                     }
                 </tbody>
                 <tfoot>
                     <tr>
                        <th colspan="3" class="text-right">Suma wpłat:</th>
                        <th class="font-bold text-lg text-success">
                            {{ totalPayments | currency:'PLN':'symbol':'1.2-2' }}
                        </th>
                     </tr>
                 </tfoot>
             </table>
         </div>
       </div>
    </div>
     
     </div>
   } @else {
    <p class="p-8 text-center">Nie znaleziono rezerwacji o podanym numerze.</p>
  }
}