<div class="chat-container container p-4 md:p-8 mx-auto max-w-350">
  <div class="flex border rounded-2xl shadow-2xl h-[80vh] bg-base-100 overflow-hidden">

    <div 
      class="w-full md:w-1/3 lg:w-1/4 border-r bg-base-200/50 flex-col conversation-list"
      [ngClass]="{ 'hidden': activeConversationId, 'md:flex': true }">
      <div class="p-4 font-bold text-lg border-b sticky top-0 bg-base-200/80 backdrop-blur-sm z-10">Konwersacje</div>
      <div class="overflow-y-auto">
        @for(convo of conversations; track convo.conversationId){
          <div class="conversation-item flex items-center gap-4 p-4 cursor-pointer"
            (click)="selectConversation(convo.conversationId)"
            [class.active]="convo.conversationId === activeConversationId">
            <div class="indicator">
              @if ((presenceService.onlineUsers$ | async)?.includes(convo.participantId)) {
                <span class="online-indicator indicator-item badge badge-success badge-xs indicator-bottom indicator-end mr-2 mb-2"></span>
              }
              <div class="avatar">
                <div class="w-12 h-12 rounded-full bg-base-300 flex items-center justify-center">
                  @if(convo.participantPhotoUrl){
                    <img [src]="convo.participantPhotoUrl" alt="Avatar rozmówcy" />
                  } @else {
                    <span class="font-bold text-lg">{{ getInitials(convo.participantName) }}</span>
                  }
                </div>
              </div>
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex justify-between items-center">
                <div class="font-bold truncate" [class.font-extrabold]="convo.unreadCount > 0">
                  {{ convo.participantName }}
                </div>
                @if (convo.unreadCount > 0) {
                  <span class="badge badge-primary badge-sm">{{ convo.unreadCount }}</span>
                }
              </div>
              <p class="text-sm text-base-content/60 truncate" [class.font-bold]="convo.unreadCount > 0">
                {{ convo.lastMessage }}
              </p>
            </div>
          </div>
        } @empty {
          <p class="p-4 text-sm text-base-content/70">Brak konwersacji.</p>
        }
      </div>
    </div>

    <div 
      class="w-full md:w-2/3 lg:w-3/4 flex flex-col"
      [ngClass]="{ 'hidden': !activeConversationId, 'md:flex': true }">
      
      @if(activeConversationId && (chatService.messageThread$ | async); as messages) {
        <div class="p-4 border-b font-bold text-lg bg-base-200/80 backdrop-blur-sm flex items-center gap-2 z-10">
          <button (click)="activeConversationId = null" class="btn btn-ghost btn-circle btn-sm md:hidden">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 19.5 8.25 12l7.5-7.5" />
            </svg>
          </button>
          <span>{{ activeParticipantName }}</span>
        </div>

        <div #messageContainer class="flex-1 p-4 overflow-y-auto bg-base-100">
          @for(message of messages; track message.messageId; let isLast = $last) {
            <div class="chat message-bubble" [class.chat-end]="message.senderId === currentUser?.id"
              [class.chat-start]="message.senderId !== currentUser?.id">
              <div class="chat-image avatar">
                <div class="w-10 rounded-full">
                  @if(message.senderPhotoUrl){
                    <img alt="Avatar nadawcy" [src]="message.senderPhotoUrl" />
                  } @else {
                    <div class="w-10 h-10 rounded-full bg-neutral text-neutral-content flex items-center justify-center">
                      <span class="font-bold text-sm">{{ getInitials(message.senderFullName) }}</span>
                    </div>
                  }
                </div>
              </div>
              <div class="chat-header text-xs opacity-60">
                {{ message.senderFullName }}
                <time class="ml-2">{{ message.sentAt | date:'HH:mm' }}</time>
              </div>
              <div class="chat-bubble rounded-2xl max-w-lg break-words text-base"
                [class.chat-bubble-primary]="message.senderId === currentUser?.id"
                [class.bg-base-300]="message.senderId !== currentUser?.id">
                {{ message.content }}
              </div>
              @if (isLast && message.senderId === currentUser?.id) {
                <div class="chat-footer opacity-50 text-xs mt-1">
                  @if (message.isRead) { 
                    <span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 inline-block -mt-1 text-info"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.052-.143z" clip-rule="evenodd" /></svg> Przeczytano</span> 
                  } @else { 
                    <span><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-4 h-4 inline-block -mt-1"><path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.052-.143z" clip-rule="evenodd" /></svg> Wysłano</span> 
                  }
                </div>
              }
            </div>
          }
        </div>

        <div class="p-4 border-t bg-base-200">
          <div class="flex items-center gap-2">
            <textarea [(ngModel)]="messageContent" (keydown.enter)="sendMessage(); $event.preventDefault()"
              class="textarea textarea-bordered w-full resize-none" placeholder="Napisz wiadomość..." rows="1"></textarea>
            <button (click)="sendMessage()" class="btn btn-primary btn-square" [disabled]="!messageContent.trim()">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="size-6">
                <path d="M3.478 2.404a.75.75 0 0 0-.926.941l2.432 7.905H13.5a.75.75 0 0 1 0 1.5H4.984l-2.432 7.905a.75.75 0 0 0 .926.94 60.519 60.519 0 0 0 18.445-8.986.75.75 0 0 0 0-1.218A60.517 60.517 0 0 0 3.478 2.404Z" />
              </svg>
            </button>
          </div>
        </div>
      } @else {
        <div class="hidden md:flex flex-col items-center justify-center h-full text-center">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-24 h-24 text-base-content/20 mb-4">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H8.25m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0H12m4.125 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 0 1-2.555-.337A5.972 5.972 0 0 1 5.41 20.97a5.969 5.969 0 0 1-.474-.065 4.48 4.48 0 0 0 .978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25Z" />
          </svg>
          <p class="text-lg text-base-content/60">Wybierz konwersację, aby rozpocząć.</p>
        </div>
      }
    </div>
  </div>
</div>