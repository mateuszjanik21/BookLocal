@if (isLoading) {
  <div class="flex justify-center items-center p-16">
    <span class="loading loading-spinner loading-lg text-primary"></span>
  </div>
} @else {
  @if (business) {
    <div class="container mx-auto p-4">
      
      <div class="relative rounded-xl overflow-hidden shadow-lg mb-8">
        <div class="absolute inset-0">
          <div class="absolute inset-0 bg-cover bg-center"
               [style.background-image]="'url(' + (business.photoUrl || 'assets/placeholder.svg') + ')'"
               style="filter: blur(20px); transform: scale(1.1);">
          </div>
          <div class="absolute inset-0 bg-black/40"></div>
        </div>
        <div class="relative p-8 md:p-12 text-white">
          <div class="flex flex-col md:flex-row items-center gap-8">
            <div class="avatar">
              <div class="w-32 md:w-40 rounded-full ring-4 ring-white/50 ring-offset-base-100 ring-offset-4">
                <img [src]="business.photoUrl || 'assets/placeholder.svg'" alt="Logo firmy {{ business.name }}" />
              </div>
            </div>
            <div class="text-center md:text-left">
              <h1 class="text-4xl md:text-5xl font-bold drop-shadow-lg">{{ business.name }}</h1>
              <p class="text-xl mt-2 opacity-80 drop-shadow-md">{{ business.city }}</p>
              @if(business.reviewCount > 0){
                <div class="flex items-center gap-2 mt-4 justify-center md:justify-start">
                  <div class="flex items-center">
                    @for (star of [1, 2, 3, 4, 5]; track star) {
                      <svg class="w-6 h-6" [ngClass]="star <= business.averageRating ? 'text-yellow-400' : 'text-gray-400'" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                    }
                  </div>
                  <span class="font-bold text-lg pt-1">{{ business.averageRating.toFixed(1) }}</span>
                  <span class="opacity-80 pt-1">({{ business.reviewCount }} opinii)</span>
                </div>
              }
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2 space-y-12">
          
          <div id="services" class="card bg-base-100 shadow-xl p-6">
            <h2 class="text-3xl font-bold mb-6 border-b pb-4">Cennik Usług</h2>
            <div class="space-y-6">
              @for (category of business.categories; track category.serviceCategoryId) {
                <div>
                  <h3 class="text-xl font-semibold text-primary mb-3">{{ category.name }}</h3>
                  <div class="space-y-3">
                    @for (service of category.services; track service.id) {
                      <div class="flex justify-between items-center p-3 rounded-lg hover:bg-base-200/50">
                        <div>
                          <p class="font-semibold">{{ service.name }}</p>
                          <p class="text-sm text-base-content/60">{{ service.durationMinutes }} min</p>
                        </div>
                        <div class="flex items-center gap-4">
                          <span class="font-mono font-semibold">{{ service.price }} zł</span>
                          @if ((authService.currentUser$ | async); as user) {
                            @if (user.roles.includes('customer')) {
                              <button class="btn btn-secondary btn-sm" (click)="openReservationModal(service, reservation_modal)">Rezerwuj</button>
                            }
                          }
                        </div>
                      </div>
                    } @empty {
                      <p>Brak usług w tej kategorii.</p>
                    }
                  </div>
                </div>
              } @empty {
                <p>Ta firma nie oferuje jeszcze żadnych usług.</p>
              }
            </div>
          </div>

          <div class="card bg-base-100 shadow-xl p-6">
            <h2 class="text-3xl font-bold mb-6 border-b pb-4">Nasz Zespół</h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-6">
              @for (employee of business.employees; track employee.id) {
                <div class="text-center">
                  <div class="avatar">
                    <div class="w-24 rounded-full ring ring-primary ring-offset-base-100 ring-offset-2">
                      <img [src]="employee.photoUrl || 'assets/placeholder.svg'" alt="Zdjęcie {{employee.firstName}}" />
                    </div>
                  </div>
                  <p class="font-bold mt-3">{{ employee.firstName }} {{ employee.lastName }}</p>
                  <p class="text-sm text-base-content/60">{{ employee.position }}</p>
                </div>
              } @empty {
                <p class="col-span-full">Brak informacji o pracownikach.</p>
              }
            </div>
          </div>

          <div class="card bg-base-100 shadow-xl p-6">
            <div class="flex justify-between items-center mb-6 border-b pb-4">
              <h2 class="text-3xl font-bold">Opinie Klientów</h2>
              @if ((authService.currentUser$ | async); as user) {
                @if (user.roles.includes('customer') && canUserPostReview) {
                  <button class="btn btn-primary btn-sm" (click)="openReviewModal()">Dodaj opinię</button>
                }
              }
            </div>
            @if (isReviewsLoading) {
              <div class="flex justify-center p-8"><span class="loading loading-spinner"></span></div>
            } @else {
              <div class="space-y-8">
                @for (review of reviews; track review.reviewId) {
                  <div class="flex gap-4">
                    <div class="avatar">
                      @if (review.reviewerPhotoUrl) {
                        <div class="w-12 h-12 rounded-full">
                          <img [src]="review.reviewerPhotoUrl" alt="Zdjęcie profilowe {{ review.reviewerName }}" />
                        </div>
                      } @else {
                        <div class="placeholder bg-neutral text-neutral-content rounded-full w-12 h-12">
                          <span class="text-lg">{{ getInitials(review.reviewerName) }}</span>
                        </div>
                      }
                    </div>
                    <div class="flex-grow">
                      <div class="flex justify-between items-start">
                        <div>
                          <p class="font-bold">{{ review.reviewerName }}</p>
                          <time class="text-xs text-base-content/60">{{ review.createdAt | date: 'dd MMMM yyyy' }}</time>
                        </div>
                        <div class="flex items-center gap-2">
                          <div class="flex items-center">
                            @for (star of [1, 2, 3, 4, 5]; track star) {
                              <svg class="w-5 h-5" [ngClass]="star <= review.rating ? 'text-yellow-400' : 'text-base-300'" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" /></svg>
                            }
                          </div>
                          @if ((authService.currentUser$ | async); as user) {
                            @if (user.id === review.userId) {
                              <div class="dropdown dropdown-end">
                                <label tabindex="0" class="btn btn-ghost btn-xs btn-circle">
                                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-4 h-4"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 12.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 18.75a.75.75 0 110-1.5.75.75 0 010 1.5z" /></svg>
                                </label>
                                <ul tabindex="0" class="dropdown-content menu p-2 shadow bg-base-100 rounded-box w-32 z-10 border">
                                  <li><button (click)="openEditReviewModal(review)">Edytuj</button></li>
                                  <li><button (click)="onDeleteReview(review)" class="text-error">Usuń</button></li>
                                </ul>
                              </div>
                            }
                          }
                        </div>
                      </div>
                      @if(review.comment) {
                        <p class="mt-2 text-base-content/90 bg-base-200/50 p-3 rounded-lg">{{ review.comment }}</p>
                      }
                    </div>
                  </div>
                } @empty {
                  <div class="text-center py-8">
                    <p class="text-base-content/70">Ta firma nie ma jeszcze żadnych opinii. Bądź pierwszy!</p>
                  </div>
                }
              </div>
            }
          </div>
        </div>

        <div class="lg:col-span-1">
          <div class="card bg-base-100 shadow-xl sticky top-8">
            <div class="card-body">
              <h2 class="card-title">O Nas</h2>
              <p class="text-base-content/80">{{ business.description }}</p>
              <div class="divider"></div>
              <p><strong>Lokalizacja:</strong> {{ business.city }}</p>
              <div class="card-actions justify-end mt-4">
                <button (click)="scrollToServices()" class="btn btn-primary w-full">Zarezerwuj Usługę</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

  } @else {
    <div class="text-center p-8">
      <h2 class="text-2xl font-bold text-error">Wystąpił błąd</h2>
      <p>Nie udało się załadować danych firmy lub firma o podanym ID nie istnieje.</p>
    </div>
  }
}

<app-reservation-modal #reservation_modal [service]="selectedService" [employees]="filteredEmployees"></app-reservation-modal>

@if(isReviewModalVisible) {
  <app-add-review-modal
    [businessId]="business!.id"
    (closed)="closeReviewModal($event)">
  </app-add-review-modal>
}

@if(isEditReviewModalVisible) {
  <app-edit-review-modal
    [businessId]="business!.id"
    [review]="reviewToEdit!"
    (closed)="closeEditReviewModal($event)">
  </app-edit-review-modal>
}